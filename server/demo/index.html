<!doctype html>
<html lang="en" ng-app="demo">
  <head>

    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
    <script src="https://code.jquery.com/jquery-2.2.4.min.js" integrity="sha256-BbhdlvQf/xTY9gja0Dq3HiwQF8LaCRTXxZKRutelT44=" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" />
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/async/2.1.4/async.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.8.3/underscore-min.js"></script>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.0.3/leaflet.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.0.3/leaflet.js"></script>

    <style>
      .wofinfo {
        margin: 0;
        padding: 0;
        display: inline-block;
      }
      #tokens {
        margin: 0;
        padding: 0;
        display: inline-block;
      }
      .wofinfo a {
        font-size:9px;
        padding: 2px;
        padding-left: 0px;
      }
      .wofinfo em {
        font-size:9px;
        padding: 2px;
        /*padding-right: 0px;*/
        font-style: normal;
      }
    </style>

    <script>
      var style = {
        stroke: true,
        color: 'blue',
        opacity: 0.5,
        dashArray: '8, 5',
        fillColor: 'blue',
        fillOpacity: 0.0,
        weight: 2
      };

      function exec( text ){

        var documents = {};
        console.info( 'search', text );

        query( text, function( ids ){
          console.log( 'ids', ids );

          $('#results li').remove();
          $('#tokens').empty();
          clearMap();

          findbyid( ids, function( docs ){

            // console.log( docs );
            var parentIds = {};

            _.mapObject( docs, function( doc, id ){

              if( !doc.lineage ){
                doc.lineage = {};
              }

              // console.info( 'set doc', id, doc );
              documents[ id ] = doc;

              _.mapObject( doc.lineage, function( val, key ){
                parentIds[ val ] = true;
              });

            });

            // @todo remove findids from parentIds
            findbyid( Object.keys( parentIds ), function( docs2 ){

              _.mapObject( docs2, function( val, key ){
                documents[ key ] = val;
              });

              tokenize( text, function( groups ){
                render( documents, ids, groups );
              });
            });
          });
        });
      }

      function render( documents, ids, tokens ){

        // display token groups
        tokens.forEach( function( win ){

          var buttons = win.map( function( token ){
            return '<li type="button" class="btn btn-default" style="margin-top: 5px;"><span>' + token + '</span></li>';
          });

          $("#tokens").append('<li><ul style="margin: 0; padding: 5px; padding-top: 0; list-style: none; background-color: #efefef; margin-bottom: 5px;">' + buttons.join('\n') + '</ul></li>' );
        })

        var bboxes = [];

        ids.forEach( function( id ){

          var doc = documents[ id ];
          if( !doc ){
            console.error( 'DOC NOT FOUND!', 'ANSWER', id );
          }
          var view = [];
          // view.push( JSON.stringify( ans ) );

          // aggregate the bboxes
          if( doc.geom && doc.geom.bbox ){
            bboxes.push( doc.geom.bbox );
          }

          var order = [
            'venue', 'address', 'building', 'campus', 'microhood', 'neighbourhood', 'macrohood', 'burough', 'postalcode',
            'locality', 'metro area', 'localadmin', 'county', 'macrocounty', 'region', 'macroregion', 'country', 'empire', 'continent', 'ocean', 'planet'
          ];

          var parentids = [];
          order.forEach( function( o ){
            var k = o + '_id';
            if( doc && doc.lineage && doc.lineage.hasOwnProperty( k ) ){
              parentids.push( doc.lineage[k] );
            }
          });

          // console.log( 'parentids', parentids );

          view = view.concat( parentids.map( function( parentid, i ){

            var parent = documents[ parentid ];
            if( !parent ){
              console.error( 'DOC NOT FOUND!', 'PARENT', parentid );
              console.error( 'skip', parentid );
              return;
            }
            if( !parent.names ){
              parent.names = {};
            }

            var v = Array(i).join('&nbsp;&nbsp;&nbsp;');
            if( i > 0 ){ v += 'â”” '; }
            v += '<strong>' + ( parent.name || '??' ) + '</strong>';
            v += '<div class="wofinfo">';
            v += '<em>' + ( parent.placetype || '??' ) + '</em>';
            v += '<a href="https://whosonfirst.mapzen.com/spelunker/id/' + ( parentid || '??' ) + '">' + ( parentid || '??' ) + '</a>';
            v += '</div>';
            return v;
          }).filter(function( val ){
            return !!val;
          }));

          // console.log( lins[i] );
          $("#results").append('<li class="list-group-item"><span>' + view.join('<br />') + '</span></li>');
        });

        updateMap( bboxes );
      }

      function request( url, params, cb ){
        $.ajax({
            url: url ,
            method: 'GET',
            data: params,
            headers: { 'Accept': 'application/json' }
          })
          .done(cb);
      };

      function query( text, cb ){
        console.info( 'query', text );
        request( '/parser/query', { text: text }, cb );
      }

      function findbyid( ids, cb ){
        console.info( 'findbyid', ids );
        request( '/parser/findbyid', { ids: ids.join(',') }, cb );
      }

      function tokenize( text, cb ){
        console.info( 'tokenize', text );
        request( '/parser/tokenize', { text: text }, cb );
      }

      function clearMap(){
        document.layer.clearLayers()
      }

      function updateMap( bboxes ){

        clearMap()

        bboxes.forEach( function( bbox ){
          var split = bbox.split(',');
          var bounds = [[split[1], split[0]], [split[3], split[2]]];
          var rect = L.rectangle(bounds, style);
          rect.addTo(document.layer);
        });

        document.map.fitBounds( document.layer.getBounds() );
      }

      $(document).ready(function() {

        $('#search').on( 'submit', function( e ){
          exec( $('#text').val() );
          return false;
        });

        $('#go').on( 'click', function( e ){
          $('#search').submit();
          return false;
        });

        $('#text').val( 'Example Street Neutral Bay North Sydney New South Wales 9999 AU' );
        $('#search').submit();

        // create map
        var map = L.map('map');
        var tiles = 'http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png';

        L.tileLayer( tiles, {
          scrollWheelZoom: true,
          zoomControl: true,
          attributionControl: false,
        }).addTo(map);

        map.setView( new L.LatLng( 52.52, 13.40 ), 14 );

        var bboxLayer = L.geoJson();
        bboxLayer.addTo(map);

        document.map = map;
        document.layer = bboxLayer;
      });
    </script>

  </head>
  <body>

    <div style="margin:20px;">

      <form id="search" action="">
        <div class="row">
          <div class="col-lg-6">

            <div class="input-group">
              <input id="text" type="text" class="form-control" placeholder="Search for...">
              <span class="input-group-btn">
                <button id="go" class="btn btn-default" type="button">Parse!</button>
              </span>
            </div><!-- /input-group -->

            <ul id="tokens" class="btn-group" role="group" style="margin-top:10px; list-style: none;"></ul>
            <ul id="results" class="list-group" style="margin-top:10px;"></ul>
          </div><!-- /.col-lg-6 -->

          <div class="col-lg-6" style="">
            <div id="map" style="width:100%; height:100%; height: 90vh;" />
          </div><!-- /.col-lg-6 -->
        </div><!-- /.row -->
      </form>

    </div>

  </body>
</html>
